<?php

/*
 Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» webhook_handler.php Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ ÑÐ¾Ð±Ð¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð²ÐµÐ±Ñ…ÑƒÐºÐ° (webhook handler) Ð½Ð° ÑÐ·Ñ‹ÐºÐµ PHP.
ÐžÐ½ Ð¿Ñ€ÐµÐ´Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð²Ñ…Ð¾Ð´ÑÑ‰Ð¸Ñ… HTTP-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² (Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ POST-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²) Ð¾Ñ‚ Ð²Ð½ÐµÑˆÐ½ÐµÐ³Ð¾ ÑÐµÑ€Ð²Ð¸ÑÐ°,
ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸ÑÑ… (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð¹ Ð·Ð°Ð´Ð°Ñ‡Ð¸).
Ð’ Ð´Ð°Ð½Ð½Ð¾Ð¼ ÑÐ»ÑƒÑ‡Ð°Ðµ, ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð² Telegram-ÐºÐ°Ð½Ð°Ð».
 */
/*

*/

// Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÑÑ‚Ñ€Ð¾Ð³ÑƒÑŽ Ñ‚Ð¸Ð¿Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð¿Ð¾Ð²Ñ‹ÑˆÐµÐ½Ð¸Ñ Ð½Ð°Ð´ÐµÐ¶Ð½Ð¾ÑÑ‚Ð¸ ÐºÐ¾Ð´Ð° Ð¸ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ Ð½ÐµÑÐ²Ð½Ñ‹Ñ… Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ð¹ Ñ‚Ð¸Ð¿Ð¾Ð²
declare(strict_types=1);

// ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
const BOT_TOKEN = 'Ñ‚Ð¾ÐºÐµÐ½_Ð±Ð¾Ñ‚Ð°_Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼Ð¼Ð°';
const CHANNEL_ID = 'Ð°Ð¹Ð´Ð¸_ÐºÐ°Ð½Ð°Ð»Ð°_ Ð²_Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼Ð¼Ðµ';
const TOPIC_ID = 'Ð°Ð¹Ð´Ð¸_Ñ‚Ð¾Ð¿Ð¸ÐºÐ°_Ð²_ÐºÐ°Ð½Ð°Ð»Ðµ_Ð²_Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼Ð¼Ðµ';

// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ
$payload = file_get_contents('php://input');
$data = json_decode($payload, true);

// Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐµÑÐ»Ð¸ ÑÑ‚Ð¾ Ð½Ð¾Ð²Ð°Ñ Ð·Ð°Ð´Ð°Ñ‡Ð°
if ($data['event'] === 'task-created') {
  $task = $data['payload'];

  $message = "ðŸ“‹ ÐÐ¾Ð²Ð°Ñ Ð·Ð°Ð´Ð°Ñ‡Ð°!\n\n"
    . "ðŸ“Œ ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ: {$task['title']}\n"
    . "ðŸ• Ð¡Ð¾Ð·Ð´Ð°Ð½Ð°: " . date('d.m.Y H:i', (int) ($task['timestamp'] / 1000)) . "\n"
    . "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: " . ($task['completed'] ? 'âœ… Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°' : 'ðŸ”„ Ð’ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ') . "\n";

  $params = http_build_query([
    'chat_id' => CHANNEL_ID,
    'message_thread_id' => TOPIC_ID,
    'text' => $message,
    'parse_mode' => 'HTML'
  ]);

  // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ SSL
  $context = stream_context_create([
    'ssl' => [
      'verify_peer' => false,
      'verify_peer_name' => false
    ]
  ]);

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼
  $response = file_get_contents(
    "https://api.telegram.org/bot" . BOT_TOKEN . "/sendMessage?" . $params,
    false,
    $context
  );

  // Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
  error_log("Telegram API Response: " . $response);
}

http_response_code(200);
echo json_encode(['status' => 'success']);
